# WebRTC 信令服务器需求文档
## 一、概述
本项目实现一个基于 FastAPI 的 WebRTC 高性能信令服务器，利用 Redis 管理房间和用户信息，通过 WebSocket 实现实时通信。服务器支持用户加入和离开房间、消息转发等功能，同时提供 RESTful API 用于获取房间用户列表和用户信息。
1. 使用 FastAPI 作为 Web 框架，提供高性能的异步处理能力
2. 使用 WebSocket 实现实时双向通信
3. 实现房间管理功能，支持多个独立会话
4. 处理 SDP Offer/Answer 和 ICE 候选的转发


## 二、功能需求
### 2.1 系统配置
从环境变量中读取 Redis 连接信息（主机地址、端口、数据库编号、密码），若未设置则使用默认值。
定义 Redis 键前缀，用于区分房间和用户信息。
### 2.2 Redis 连接
提供一个函数用于创建 Redis 客户端实例，设置 decode_responses 为 True 以返回字符串类型的数据。
### 2.3 数据模型
定义消息数据模型 Message，包含消息类型 type、目标用户 target 和消息负载 payload。
### 2.4 信令服务器核心功能
#### 2.4.1 连接管理
处理新的 WebSocket 连接，验证用户 ID 和房间 ID 的有效性。
接受连接后，将用户加入指定房间，并记录用户连接信息。
进入消息循环，接收并处理用户发送的消息。
处理连接断开事件，将用户从房间中移除，并通知其他用户。
#### 2.4.2 房间管理
用户加入房间：使用 Redis 事务确保原子性操作，将用户添加到房间集合中，记录用户信息（包含加入时间），并设置房间和用户信息的过期时间（30 分钟）。通知房间内其他用户有新用户加入，并向新用户发送房间内现有用户列表。
用户离开房间：从 Redis 中移除用户的房间信息和用户信息，通知房间内其他用户该用户已离开。
#### 2.4.3 消息处理
接收用户发送的消息，验证目标用户是否在同一房间。
若目标用户在线且在同一房间，将消息转发给目标用户；否则，记录相应警告信息。
#### 2.4.4 信息查询
提供方法获取指定房间的所有用户列表。
提供方法获取指定用户的详细信息，包括加入时间。
### 2.5 WebSocket 端点
提供 /ws/{room_id}/{user_id} 端点，处理 WebSocket 连接请求。
### 2.6 RESTful API 端点
获取房间用户列表：/rooms/{room_id}/users，返回指定房间的所有用户列表。
获取用户信息：/users/{user_id}，返回指定用户的详细信息，若用户不存在则返回 404 错误。
### 2.7 生命周期管理
启动事件：服务器启动时记录启动日志，可添加额外启动逻辑。
关闭事件：服务器关闭时记录关闭日志，可添加清理逻辑。
## 三、非功能需求
### 3.1 日志记录
配置日志级别为 INFO，记录用户连接、断开、消息转发等关键操作信息，以及错误和警告信息。
### 3.2 性能要求
使用 Redis 事务确保关键操作的原子性，提高数据一致性。
设置 Redis 键的过期时间，自动清理过期的房间和用户信息，减少内存占用。
## 四、技术栈
* 编程语言：Python 3.12.0
* Web 框架：FastAPI~=0.116.0
* 实时通信：WebSocket
* 数据存储：Redis~=6.2.0
* 类型注解：Python typing 模块
* 数据验证：Pydantic~=2.11.7
* 异步编程：asyncio













WebRTC 信令服务器在实时通信中扮演关键角色，主要负责建立连接前的元数据交换和连接管理。以下是信令服务器的核心功能及其实现要点：
1. 连接管理
用户注册与发现：
管理用户在房间中的加入 / 离开状态
维护在线用户列表并实时同步
示例：通过 Redis 存储房间和用户信息，支持分布式部署
会话生命周期管理：
检测用户断开连接并自动清理资源
设置会话超时机制（如 30 分钟无活动则过期）
支持优雅关闭连接（发送 user_left 通知）
2. 消息转发
SDP Offer/Answer 交换：
转发 WebRTC 会话描述协议（SDP），包括媒体能力和网络配置
示例消息格式：
json
{
  "type": "sdp_offer",
  "target": "user2",
  "payload": { "sdp": "v=0\r\no=..." }
}

ICE 候选转发：
传递网络候选地址（NAT 穿透信息）
示例消息格式：
json
{
  "type": "ice_candidate",
  "target": "user2",
  "payload": {
    "candidate": "candidate:0 1 UDP 2122260223 ...",
    "sdpMid": "audio",
    "sdpMLineIndex": 0
  }
}

点对点消息：
支持定向消息（如文字聊天、文件传输请求）
实现广播功能（向房间内所有用户发送消息）
3. 房间管理
动态创建与销毁：
用户可创建临时房间或加入已有房间
当最后一个用户离开时自动销毁房间
通过 Redis 原子操作保证并发安全
房间权限控制：
支持密码保护房间
实现主持人 / 观众角色区分（如只允许主持人发布媒体）
4. 身份验证与安全
用户身份验证：
集成 JWT 或 OAuth 进行身份验证
验证用户权限（如是否有权限加入特定房间）
消息加密：
使用 TLS 加密 WebSocket 连接
对敏感消息内容（如 SDP）进行额外加密
5. 监控与统计
性能指标：
记录连接数、消息吞吐量、响应时间
监控 Redis 连接状态和内存使用
错误日志：
捕获并记录连接异常、消息转发失败等
实现告警机制（如连接数突增或 Redis 断开）
6. 扩展性与高可用
分布式部署：
支持多实例负载均衡（如使用 Nginx 或 Kubernetes）
通过 Redis 实现跨实例状态共享
水平扩展：
支持动态添加 / 减少服务器实例
实现会话亲和性（Sticky Session）确保消息一致性
7. REST API 支持
管理接口：
查询房间列表和在线用户
强制断开特定连接
生成临时访问令牌
状态查询：
获取服务器负载和资源使用情况
查询特定房间的活跃用户数
信令流程示例
用户 A 加入房间：
发送 user_joined 通知给房间内其他用户
返回当前房间用户列表给 A
用户 A 发起通话：
A 生成 SDP Offer 并发送给服务器
服务器转发 Offer 至目标用户 B
用户 B 响应：
B 生成 SDP Answer 并通过服务器回传给 A
A/B 开始交换 ICE 候选直到建立连接
技术实现建议
推荐框架：Python (FastAPI/Flask)、Node.js (Socket.IO)、Go (Gin)
存储方案：Redis（高性能、支持过期机制）
部署方式：Docker + Kubernetes（便于扩展和管理）
安全配置：启用 TLS、设置合理的 CORS 策略